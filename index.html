<!doctype html>
<!--
  קובץ יחיד: "פשוט סיפור" (עברית בלבד)
  תיאור: אתר צד-לקוח בלבד (HTML/CSS/JS) לשכתוב סיפורים ויצירת קובצי שמע בעזרת מפתח API של המשתמש.
  הערות חשובות (קרא לפני שימוש):
  1. הקוד מנסה לשלוח בקשות ישירות ל-API של Google Generative AI; יש לוודא שהסביבת ה-API תומכת בקריאות מדפדפן (CORS).
  2. חשיפת מפתח ה-API בצד הלקוח היא מסוכנת — כל מי שיגיע לדף יוכל לראות ולגנוב את המפתח. מומלץ להשתמש בפרוקסי/Backend מאובטח אם זהו מפתח אמיתי.
  3. אם הבקשות ל-Google נכשלות (CORS/מפתח), ישנה נפילה ל-Web Speech API לצורך הדגמה מקומית.
  4. המשתמש מוסר את המפתח מרצונו; האתר שומר מפתח זה ב-LocalStorage.

  החלפת נקודות: יש לעדכן את המחרוזות של ENDPOINT_TEXT ו-ENDPOINT_TTS לפי התיעוד העדכני של Google Generative AI/Cloud Text-to-Speech.
-->
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>פשוט סיפור</title>
  <style>
    :root{
      --bg:#fbfbfc; --card:#ffffff; --muted:#6b6b6b; --accent:#0b72ff; --danger:#d9534f;
      --radius:14px; --shadow: 0 6px 18px rgba(18,24,40,0.06);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans Hebrew", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:#111; -webkit-font-smoothing:antialiased; padding:24px; display:flex; justify-content:center; align-items:flex-start;
    }
    .container{width:100%; max-width:980px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    h1{margin:0;font-size:22px}
    p.lead{margin:0;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media (max-width:880px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .card h2{margin-top:0}

    /* API key area */
    .api-row{display:flex;gap:8px;align-items:center}
    input[type=text], textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e6e9;font-size:15px}
    textarea{min-height:110px;resize:vertical}
    button{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button.secondary{background:transparent;color:var(--accent);border:1px solid rgba(11,114,255,0.12)}
    button.danger{background:var(--danger)}

    .examples{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{background:#f2f6ff;color:var(--accent);padding:8px 10px;border-radius:999px;border:1px solid rgba(11,114,255,0.06);cursor:pointer}

    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}

    /* History */
    .history-list{display:flex;flex-direction:column;gap:8px}
    .history-item{padding:10px;border-radius:10px;border:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center}
    .history-item .meta{display:flex;flex-direction:column}
    .controls{display:flex;gap:8px;align-items:center}

    /* audio player */
    .player{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    audio{width:100%}

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

    .notice{background:#fff8e6;border:1px solid #ffecb5;padding:10px;border-radius:10px;margin-bottom:12px}

    .loader{display:inline-block;width:18px;height:18px;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>פשוט סיפור</h1>
        <p class="lead">צור תסריט דיאלוגי בעברית והמר אותו לקובץ שמע — הכל בצד הלקוח.</p>
      </div>
      <div class="muted small">הנתונים נשלחים ישירות ל-Google Generative AI בעזרת המפתח שלך</div>
    </header>

    <div class="grid">
      <!-- MAIN -->
      <main class="card">
        <div class="notice">
          <strong>הערה חשובה:</strong> כדי ליצור סיפורים, הזן את מפתח ה-API שלך מ-Google AI Studio. המפתח נשמר ב-LocalStorage בדפדפן שלך בלבד.
        </div>

        <section id="api-section">
          <h2>מפתח API</h2>
          <div class="api-row" style="margin-bottom:8px">
            <input id="apiKeyInput" type="text" placeholder="הדבק כאן את מפתח ה-API שלך" autocomplete="off" />
            <button id="saveApiBtn">שמור</button>
            <button id="updateApiBtn" class="secondary">עדכן מפתח API</button>
          </div>
          <div class="muted">המפתח נשמר מקומית במכשיר זה. מומלץ לא לשתף את המפתח ולשקול שימוש בפרוקסי מאובטח.</div>
        </section>

        <hr style="margin:16px 0" />

        <section id="create-section">
          <h2>צור סיפור חדש</h2>
          <label class="small muted">תן לנו נושא לסיפור</label>
          <textarea id="promptInput" placeholder="למשל: ילד שמוצא מפה מסתורית, או דיאלוג חם על אחווה בעיר קטנה"></textarea>

          <div class="examples" aria-hidden>
            <div class="chip">הרפתקה בלילה גשום</div>
            <div class="chip">שיחה בין סבא לנכדה</div>
            <div class="chip">תעלומה בבית ישן</div>
            <div class="chip">מפגש מקרי שמשנה חיים</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <button id="createBtn">צור סיפור</button>
            <div id="status" class="muted small"></div>
          </div>

          <div id="storyResult" style="margin-top:12px;display:none">
            <h3>תסריט שנוצר</h3>
            <div id="scriptText" class="muted small" style="white-space:pre-wrap"></div>

            <div class="player" id="playerArea" style="display:none">
              <audio id="audioPlayer" controls></audio>
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="muted small">הנגן למעלה. ניתן להוריד את הקובץ או להשמיע שוב.</div>
                <div class="controls">
                  <a id="downloadLink" class="small" download>הורד סיפור</a>
                </div>
              </div>
            </div>
          </div>
        </section>

      </main>

      <!-- SIDEBAR -->
      <aside class="card">
        <h2>היסטוריית הסיפורים שלי</h2>
        <div id="history" class="history-list"></div>
        <div style="margin-top:12px">
          <button id="clearHistoryBtn" class="danger">מחק היסטוריה</button>
        </div>

        <hr style="margin:12px 0" />
        <h3>שקיפות ובטיחות</h3>
        <p class="muted small">האתר ישלח את הטקסט ומפתח ה-API ישירות לשירותי Google Generative AI לצורך יצירת תסריט וקובץ שמע. אם הקריאות נתקעות בגלל מדיניות CORS או סיבות אחרות, תוצג חלופה מקומית (Web Speech API) לצורך הדגמה.</p>
      </aside>
    </div>

    <footer>
      <div class="muted small">פשוט סיפור — כל הזכויות שמורות לך. הקוד פתוח לשימוש אישי. שימו לב לסיכוני אבטחה בשמירת מפתחות ב-LocalStorage.</div>
    </footer>
  </div>

  <script>
    // קובץ יחיד — כל ה-JS כאן
    // התאמה: יש למלא את ה-ENDPOINT_TEXT וה-ENDPOINT_TTS לפי תיעוד Google הנוכחי.

    const STORAGE = {
      API_KEY: 'pashut_sipur_api_key_v1',
      STORIES: 'pashut_sipur_stories_v1'
    };

    // ------------------------------------------------------------------
    // NOTE: בדוגמה זו ה-ENDPOINTים הם placeholders. יש לעדכן בהתאם לתיעוד של Google.
    // דוגמאות אפשריות (לא מוסמך כנכון):
    // - טקסט: https://generativelanguage.googleapis.com/v1beta2/models/gemini-pro:generateText
    // - TTS: https://texttospeech.googleapis.com/v1/text:synthesize
    // הקפד: בדפדפנים רבים קריאות ל-API אלה ייחסמו על ידי CORS אם Google לא אפשרו קריאות מדפדפן.

    const ENDPOINT_TEXT = 'https://YOUR_GOOGLE_GENERATIVE_TEXT_ENDPOINT';
    const ENDPOINT_TTS = 'https://YOUR_GOOGLE_TTS_ENDPOINT';

    // רכיבי DOM
    const apiInput = document.getElementById('apiKeyInput');
    const saveApiBtn = document.getElementById('saveApiBtn');
    const updateApiBtn = document.getElementById('updateApiBtn');
    const promptInput = document.getElementById('promptInput');
    const createBtn = document.getElementById('createBtn');
    const status = document.getElementById('status');
    const scriptText = document.getElementById('scriptText');
    const storyResult = document.getElementById('storyResult');
    const playerArea = document.getElementById('playerArea');
    const audioPlayer = document.getElementById('audioPlayer');
    const downloadLink = document.getElementById('downloadLink');
    const historyEl = document.getElementById('history');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');

    // דוגמאות - קליק על chip יכניס טקסט
    document.querySelectorAll('.chip').forEach(ch=>ch.addEventListener('click',e=>{promptInput.value = ch.textContent;}));

    // טענת מפתח במידה וקיים
    function loadApiKey(){
      const k = localStorage.getItem(STORAGE.API_KEY);
      if(k){ apiInput.value = k; apiInput.disabled = true; saveApiBtn.textContent = 'שמירה'; }
    }

    // שמירת מפתח
    saveApiBtn.addEventListener('click', ()=>{
      const k = apiInput.value.trim();
      if(!k){ alert('הזן מפתח לפני שמירה'); return; }
      localStorage.setItem(STORAGE.API_KEY,k);
      apiInput.disabled = true;
      status.textContent = 'מפתח נשמר';
      setTimeout(()=>status.textContent='',1500);
    });

    updateApiBtn.addEventListener('click', ()=>{
      apiInput.disabled = false; apiInput.focus();
    });

    // היסטוריה
    function loadStories(){
      const raw = localStorage.getItem(STORAGE.STORIES);
      try{
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveStories(arr){ localStorage.setItem(STORAGE.STORIES, JSON.stringify(arr)); }

    function renderHistory(){
      const arr = loadStories();
      historyEl.innerHTML = '';
      if(arr.length===0){ historyEl.innerHTML = '<div class="muted">אין סיפורים בשמירה</div>'; return; }
      arr.slice().reverse().forEach((s,idx)=>{
        const item = document.createElement('div'); item.className='history-item';
        const meta = document.createElement('div'); meta.className='meta';
        const title = document.createElement('div'); title.textContent = s.title || ('סיפור ' + (arr.length - idx));
        const date = document.createElement('div'); date.className='muted small'; date.textContent = new Date(s.createdAt).toLocaleString('he-IL');
        meta.appendChild(title); meta.appendChild(date);

        const ctr = document.createElement('div'); ctr.className='controls';
        const playBtn = document.createElement('button'); playBtn.textContent='נגן'; playBtn.className='secondary';
        playBtn.addEventListener('click', ()=>{ loadStoryToPlayer(s); });
        const delBtn = document.createElement('button'); delBtn.textContent='מחק'; delBtn.className='danger';
        delBtn.addEventListener('click', ()=>{ if(confirm('למחוק סיפור זה מההיסטוריה?')){ deleteStory(s.id); } });
        ctr.appendChild(playBtn); ctr.appendChild(delBtn);

        item.appendChild(meta); item.appendChild(ctr);
        historyEl.appendChild(item);
      });
    }

    function addStoryToHistory(story){
      const arr = loadStories(); arr.push(story); saveStories(arr); renderHistory();
    }
    function deleteStory(id){
      const arr = loadStories().filter(s=>s.id!==id); saveStories(arr); renderHistory();
    }
    clearHistoryBtn.addEventListener('click', ()=>{
      if(confirm('למחוק את כל ההיסטוריה?')){ localStorage.removeItem(STORAGE.STORIES); renderHistory(); }
    });

    // יצירה: שלב ראשון - בקשת טקסט
    async function generateScript(prompt, apiKey){
      // בנייה של בקשת ה-API לטקסט — עדכן בהתאם לצורת ה-API האמיתית
      const body = {
        prompt: prompt,
        // ניתן להוסיף פרמטרים נוספים לפי תיעוד ה-API
      };

      const res = await fetch(ENDPOINT_TEXT, {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer ' + apiKey
        },
        body: JSON.stringify(body)
      });

      if(!res.ok){
        const txt = await res.text(); throw new Error('שגיאת שרת ביצירת טקסט: ' + res.status + ' - ' + txt);
      }

      const data = await res.json();
      // התאמה: זיהוי השדה שמחזיר את הטקסט משתנה בין APIs
      // למשל: data.outputText || data.candidates?.[0]?.content || data.result
      const text = (data.outputText || data.output?.[0]?.content || data.candidates?.[0]?.content || data.result || data.text);
      if(!text) throw new Error('לא נמצא שדה טקסט בתשובת ה-API. בדוק את ה-ENDPOINT והתיעוד.');
      return String(text).trim();
    }

    // שלב שני - המרת תסריט ל-Audio (TTS)
    async function generateAudioFromText(text, apiKey){
      // דוגמה לבקשה ל-TTS שמחזירה base64 ב-key "audioContent"
      const body = {
        input: { text: text },
        voice: { languageCode: 'he-IL' },
        audioConfig: { audioEncoding: 'MP3' }
      };

      const res = await fetch(ENDPOINT_TTS,{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer ' + apiKey},
        body: JSON.stringify(body)
      });
      if(!res.ok){ const txt = await res.text(); throw new Error('שגיאת שרת ב-TTS: ' + res.status + ' - ' + txt); }
      const data = await res.json();
      // צפוי: data.audioContent כ-base64
      const audioBase64 = data.audioContent || data.outputAudio || data.audio;
      if(!audioBase64) throw new Error('לא נמצא audioContent בתשובת ה-TTS. בדוק את ה-ENDPOINT והתיעוד.');
      return audioBase64;
    }

    // המרה מ-base64 ל-Blob
    function base64ToBlob(base64, mimeType='audio/mpeg'){
      const byteChars = atob(base64.replace(/^data:.*;base64,/,''));
      const byteNumbers = new Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) {
        byteNumbers[i] = byteChars.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], {type: mimeType});
    }

    // טעינת סיפור לנגן (מ-blob או base64)
    function loadStoryToPlayer(story){
      storyResult.style.display = 'block';
      scriptText.textContent = story.script || '';
      if(story.audioBase64){
        const blob = base64ToBlob(story.audioBase64);
        const url = URL.createObjectURL(blob);
        audioPlayer.src = url; audioPlayer.play().catch(()=>{});
        downloadLink.href = url; downloadLink.download = (story.title||'sipur') + '.mp3';
        playerArea.style.display='block';
      }else if(story.audioUrl){
        audioPlayer.src = story.audioUrl; audioPlayer.play().catch(()=>{});
        downloadLink.href = story.audioUrl; downloadLink.download = (story.title||'sipur') + '.mp3';
        playerArea.style.display='block';
      } else {
        playerArea.style.display='none';
      }
    }

    // יצירת מזהה ייחודי
    function uid(){ return 'id-' + Math.random().toString(36).slice(2,9); }

    // לוגיקה עיקרית
    createBtn.addEventListener('click', async ()=>{
      const prompt = promptInput.value.trim();
      if(!prompt){ alert('הזן נושא לסיפור'); return; }
      const apiKey = localStorage.getItem(STORAGE.API_KEY);
      if(!apiKey){ alert('מפתח ה-API חסר. אנא הזן ושמור אותו תחילה.'); return; }

      // עדכון מצב
      status.innerHTML = '<span class="loader"></span> יוצר תסריט...';
      createBtn.disabled = true;

      try{
        // 1. בקשת טקסט
        const script = await generateScript(prompt, apiKey);
        scriptText.textContent = script;
        storyResult.style.display = 'block';
        status.textContent = 'יוצר קובץ שמע...';

        // 2. בקשת TTS
        let audioBase64;
        try{
          audioBase64 = await generateAudioFromText(script, apiKey);
        }catch(ttsErr){
          console.error('TTS failed:', ttsErr);
          // נפילה ל-Web Speech API (מקומי) כמחסה
          status.textContent = 'שגיאת TTS - שימוש ב-Web Speech API כמחסה';
          await synthesizeLocally(script);
          // שמירה רק עם script ללא audioBase64
          const story = { id: uid(), title: prompt, script, createdAt: Date.now() };
          addStoryToHistory(story);
          status.textContent = '';
          return;
        }

        // אם קיבלנו base64
        // שמירת סיפור והצגה בנגן
        const story = { id: uid(), title: prompt, script, audioBase64, createdAt: Date.now() };
        addStoryToHistory(story);
        loadStoryToPlayer(story);
        status.textContent = 'נוצר בהצלחה';

      }catch(err){
        console.error(err);
        alert('שגיאה ביצירת הסיפור: ' + (err.message || err));
        status.textContent = '';
      }finally{
        createBtn.disabled = false;
        setTimeout(()=>status.textContent='',2000);
      }
    });

    // חלופת synth מקומית באמצעות Web Speech API
    async function synthesizeLocally(text){
      if(!('speechSynthesis' in window)) { alert('Web Speech API לא נתמך בדפדפן זה.'); return; }
      return new Promise((resolve)=>{
        const utter = new SpeechSynthesisUtterance(text);
        // הגדרות לשונית — יש לבחור בקול עברי אם קיים
        utter.lang = 'he-IL';
        utter.onend = ()=>{ resolve(); };
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utter);
      });
    }

    // אתחול
    (function init(){ loadApiKey(); renderHistory(); })();

    // דוגמאות לטעויות נפוצות וניהול שגיאות:
    // - אם ה-API יחזיר שגיאה 401/403 -> הודעה מתאימה למשתמש.
    // - אם התשובה מה-API לא תכלול שדה טקסט או שדה audioContent -> נזרק שגיאה שמבקשת בדיקה ידנית של ה-ENDPOINT.

    // שיפור אבטחה: שקול להעביר את קריאות ה-API ל-backend מאובטח שיחזיק את המפתח ולא ישאיר אותו בצד הלקוח.
  </script>
</body>
</html>
